# 订阅过期测试指南

## 功能说明

现在已添加订阅过期日期显示功能，可以在个人资料页看到会员有效期。

### 新增内容

1. **PurchaseStore.swift**
   - 新增 `subscriptionExpirationDate` 属性：追踪订阅过期时间
   - 新增 `isExpiringSoon` 计算属性：判断是否7天内过期
   - 增强日志输出：在控制台显示过期时间

2. **ContentView.swift**
   - 会员徽章下方显示："有效期至 2025-12-10"（示例格式）
   - 使用小号灰色字体，不影响主界面布局

## 如何测试订阅过期和续费

### 方法1：使用 Xcode 菜单快速测试（推荐）

1. **在 Xcode 中运行 app 到模拟器**
   ```
   Command + R
   ```

2. **完成一次订阅购买**
   - 打开 app
   - 进入 Onboarding 或通过 AI 助手触发 Paywall
   - 选择 Plus 月度或 Pro 年度
   - 完成测试购买（测试环境无需真实支付）

3. **查看订阅状态**
   - 进入个人资料页（Profile Tab）
   - 查看会员徽章下方的"有效期至"日期
   - 记录当前过期时间

4. **使用 Xcode 菜单立即使订阅过期**
   ```
   Xcode 菜单栏 → Debug → StoreKit → Expire Subscription
   ```
   - 选择要过期的订阅（Plus 或 Pro）
   - 点击 "Expire Subscription"
   - 订阅将立即过期

5. **观察变化**
   - 回到 app 的个人资料页
   - 会员徽章应该消失
   - "有效期至"文字也会消失
   - 控制台会显示：`[IAP] Subscription expires at: [过期时间]`

6. **测试续费**
   - 再次触发购买流程
   - 选择相同或不同的订阅计划
   - 完成购买
   - 验证会员徽章重新出现
   - 验证新的过期日期显示

### 方法2：查看和管理所有交易

在 Xcode 运行期间：

```
Xcode 菜单栏 → Debug → StoreKit → Manage Transactions
```

这个窗口可以：
- 查看所有测试交易记录
- 手动过期任何订阅
- 触发订阅续订
- 清除所有交易（重新开始测试）

### 方法3：清除所有交易重新测试

```
Xcode 菜单栏 → Debug → StoreKit → Clear Transactions
```

这会：
- 删除所有测试购买记录
- 重置订阅状态
- 让您从头开始测试购买流程

## 控制台日志查看

在 Xcode 底部的控制台（Console）中，您可以看到相关日志：

```
[IAP] Loading products for ids: ["com.hulubeici.plus.monthly", "com.hulubeici.pro.yearly"]
[IAP] Loaded products: ["com.hulubeici.plus.monthly", "com.hulubeici.pro.yearly"]
[IAP] Subscription expires at: 2025-12-10 08:30:15 +0000
```

## 测试场景建议

### 场景1：Plus 月度订阅过期
1. 购买 Plus 月度订阅
2. 查看个人资料页，确认显示 "Plus会员" 和过期日期
3. 使用 Xcode 菜单使其过期
4. 确认徽章消失
5. 重新购买，确认状态恢复

### 场景2：Pro 年度订阅过期
1. 购买 Pro 年度订阅
2. 查看个人资料页，确认显示 "Pro会员" 和过期日期
3. 使用 Xcode 菜单使其过期
4. 确认徽章消失
5. 购买 Plus 月度，确认可以降级

### 场景3：从 Plus 升级到 Pro
1. 购买 Plus 月度
2. 查看过期日期
3. 购买 Pro 年度（升级）
4. 确认徽章变为 "Pro会员"
5. 确认过期日期更新为1年后

### 场景4：订阅过期后的功能限制测试
1. 购买任意订阅
2. 使用 AI 助手等高级功能（确认可用）
3. 使用 Xcode 使订阅过期
4. 尝试访问 AI 助手
5. 确认显示 Paywall 要求重新订阅

## 常见问题

### Q: 为什么没有显示过期日期？
A: 可能原因：
1. 订阅购买尚未完成
2. Transaction 尚未同步
3. 查看控制台是否有错误日志

### Q: 过期后徽章没有消失怎么办？
A:
1. 等待几秒让 Transaction.updates 触发
2. 重启 app（停止运行再重新运行）
3. 检查 PurchaseStore 是否正确监听 Transaction.updates

### Q: 测试完成后如何清理？
A: 使用 Xcode → Debug → StoreKit → Clear Transactions 清除所有测试数据

## 注意事项

1. **StoreKit Testing 仅在模拟器和 Xcode 调试时有效**
   - 真机测试需要连接 TestFlight 或 App Store Connect

2. **时间加速功能未启用**
   - 当前配置为实时（`_timeRate: 0`）
   - 如需自动加速，可修改 StoreKit.storekit 文件

3. **过期时间为 UTC 时区**
   - 显示的日期已转换为本地日期格式
   - 控制台日志显示的是 UTC 时间

4. **每次重新构建会重置测试环境**
   - Clean Build 后需要重新购买测试订阅
   - 使用增量构建（不 Clean）可保留测试数据

## 下一步优化建议

如果需要更快速的测试，可以考虑：
1. 启用时间加速（修改 `_timeRate` 为 300，月度订阅约10分钟过期）
2. 添加 UI 按钮手动触发过期检查
3. 添加过期提醒通知
4. 实现自动续订失败的优雅降级
