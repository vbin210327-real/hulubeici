# 正确的订阅过期测试方法

## 问题原因

Xcode 的 StoreKit Transaction Manager **没有 "Expire Subscription" 按钮**，只有 "Delete Subscription"。

所以我为你添加了 **3 种测试方法**：

---

## 方法 1：一键强制过期（最简单！）⭐️

这是我刚刚添加的调试功能，可以直接模拟订阅过期状态。

### 步骤：

1. **运行 App**
2. **点击右上角设置按钮（齿轮图标）**
3. **选择"强制设为过期 (调试)"**（红色按钮）
4. **立即查看效果**

就这么简单！现在你应该看到：
- ✅ 灰色徽章："Plus会员已过期" 或 "Pro会员已过期"
- ✅ 红色文字："已于 [日期] 过期"

### 控制台日志：
```
[DEBUG] Forcing subscription to expired state
[DEBUG] Forced state - isPremium: false, expirationDate: 2025-11-09 12:00:00, previousTier: plus
[DEBUG] hasExpired should now be: true
[IAP hasExpired] isPremium: false, expirationDate: 2025-11-09 12:00:00, now: 2025-11-10 12:00:00, previousTier: plus, result: true
```

---

## 方法 2：等待自然过期（真实测试）

我已经将时间加速从 7 倍改为 **3600 倍**：
- **1 个月 = 12 分钟**
- **1 天 = 24 秒**

### 步骤：

1. **运行 App**
2. **购买 Plus Monthly 订阅**
3. **等待 12 分钟**（或在 Transaction Manager 中手动推进时间）
4. **点击"刷新订阅状态 (调试)"**
5. **查看过期状态**

### 如何手动推进时间：

在 Transaction Manager 中：
1. 打开 Xcode → Debug → StoreKit → Manage Transactions (⇧⌘T)
2. 点击右上角的 **时钟图标** ⏰
3. 手动推进时间到订阅过期日之后
4. 回到 App，点击"刷新订阅状态 (调试)"

---

## 方法 3：删除订阅后等待（模拟真实场景）

这个方法最接近真实用户体验。

### 步骤：

1. **运行 App**
2. **购买订阅**
3. **在 Transaction Manager 中删除订阅**
   - Xcode → Debug → StoreKit → Manage Transactions (⇧⌘T)
   - 右键订阅 → Delete Transaction
4. **重新购买订阅**（会创建一个新的订阅）
5. **再次删除订阅**
6. **等待 12 分钟**（3600 倍加速下的 1 个月）
7. **点击"刷新订阅状态 (调试)"**

---

## 调试工具说明

### 1. "刷新订阅状态 (调试)"
- 强制重新检查订阅状态
- 会打印详细的 `[IAP]` 日志
- 用于验证订阅状态是否正确更新

### 2. "强制设为过期 (调试)" 🔴
- 直接模拟订阅过期状态
- 不需要等待或操作 Transaction Manager
- 方便快速测试"已过期"的 UI 显示

---

## 预期效果对比

### ❌ 订阅有效时（isPremium = true）
```
个人中心头像下方：
┌─────────────────────┐
│  Plus会员           │  ← 金色渐变徽章
│  有效期至 2025-12-10 │  ← 灰色文字
└─────────────────────┘
```

### ✅ 订阅过期后（isPremium = false, hasExpired = true）
```
个人中心头像下方：
┌─────────────────────┐
│  Plus会员已过期      │  ← 灰色徽章
│  已于 2025-11-10 过期│  ← 红色文字
└─────────────────────┘
```

---

## 查看调试日志

在 Xcode 控制台搜索 `[IAP` 或 `[DEBUG]`，你应该看到：

### 订阅有效：
```
[IAP] Current status - isPremium: true, tier: plus, previousTier: plus
[IAP] Subscription expiration date: 2025-12-10 12:00:00, hasExpired: false
[IAP hasExpired] isPremium: true, expirationDate: 2025-12-10 12:00:00, now: 2025-11-10 12:00:00, previousTier: plus, result: false
```

### 订阅过期：
```
[IAP] Current status - isPremium: false, tier: none, previousTier: plus
[IAP] Subscription expiration date: 2025-11-10 12:00:00, hasExpired: true
[IAP hasExpired] isPremium: false, expirationDate: 2025-11-10 12:00:00, now: 2025-11-11 12:00:00, previousTier: plus, result: true
```

---

## 重置测试环境

如果需要完全重新开始：

```bash
# 1. 删除模拟器中的 App
# 2. 在 Xcode:
#    Product → Clean Build Folder (⇧⌘K)
#    Debug → StoreKit → Editor → Clear Trusted Transaction History
# 3. 重新运行
```

---

## 常见问题

### Q: 为什么"取消订阅"后还是显示有效？
**A:** "取消订阅"只是不再续订，订阅会持续到当前计费周期结束。这是正常行为！

### Q: 我点了"强制设为过期"但还是没变化？
**A:** 检查：
1. Xcode 控制台是否有 `[DEBUG]` 日志
2. 是否重新打开了设置菜单查看
3. 尝试重启 App

### Q: 如何恢复到正常的订阅状态？
**A:**
1. 点击"刷新订阅状态 (调试)"按钮
2. 或重新购买订阅
3. 或重启 App

### Q: 时间加速 3600 倍会影响什么？
**A:** 只影响 StoreKit 测试环境，不影响：
- App 的其他功能
- 真实的 App Store 订阅
- 系统时间

---

## 推荐测试流程

**第一次测试**（验证 UI）：
```
1. 运行 App
2. 点击设置 → "强制设为过期 (调试)"
3. 检查 UI 是否正确显示"已过期"
4. 查看控制台日志
```

**完整测试**（验证逻辑）：
```
1. 运行 App
2. 购买 Plus Monthly
3. 等待 12 分钟（或手动推进时间）
4. 点击"刷新订阅状态 (调试)"
5. 验证 UI 和日志
```

---

现在请使用 **方法 1（一键强制过期）** 来测试，应该可以立即看到"已过期"状态了！
