# 如何正确测试订阅过期功能

## 问题诊断

你遇到的问题很可能是因为 **"取消订阅" ≠ "订阅过期"**。

### 关键概念

1. **取消订阅（Cancel Subscription）**：
   - 用户选择不再续订
   - 但订阅**仍然有效**，直到当前计费周期结束
   - `isPremium = true`，`expirationDate` 是未来的某个时间
   - 所以 `hasExpired = false` ✅ 这是**正确的**！

2. **订阅过期（Subscription Expired）**：
   - 当前计费周期已经结束
   - 订阅失效，用户失去会员权益
   - `isPremium = false`，`expirationDate` 在过去
   - `hasExpired = true`

## 正确的测试步骤

### 方法 1：使用 StoreKit Transaction Manager（推荐）

1. **启动 App 并购买订阅**
   ```
   - 打开模拟器中的 App
   - 购买 Plus Monthly 或 Pro Yearly
   - 确认购买成功（看到会员徽章）
   ```

2. **打开 Transaction Manager**
   ```
   Xcode 菜单 → Debug → StoreKit → Manage Transactions
   或按 ⇧⌘T
   ```

3. **让订阅立即过期**
   ```
   - 找到你的订阅交易（com.hulubeici.plus.monthly 或 pro.yearly）
   - 右键点击该交易
   - 选择 "Expire Subscription" ⚡️
   ```

   **注意**：如果没有 "Expire Subscription" 选项，说明订阅已经是过期状态了。

4. **验证过期状态**
   ```
   - 点击 App 中的 "刷新订阅状态 (调试)" 按钮
   - 或重启 App
   - 应该看到灰色徽章："Plus会员已过期" 或 "Pro会员已过期"
   - 红色文字："已于 [日期] 过期"
   ```

### 方法 2：使用加速时间（StoreKit Configuration 设置）

你的 `StoreKit.storekit` 已经设置了 `"_timeRate": 7`，这意味着时间加速 7 倍。

1. **购买月度订阅**
   - Plus Monthly 正常是 1 个月
   - 在加速模式下，1 个月 = 4.3 天
   - 所以你只需要等待约 4.3 天就会自动过期

2. **购买年度订阅**
   - Pro Yearly 正常是 1 年
   - 在加速模式下，1 年 = 52 天
   - 对测试来说太长了，不推荐

**建议**：将 `_timeRate` 改为更大的值（如 `3600` 表示加速 3600 倍，1 个月只需要 12 分钟）

### 方法 3：使用 Xcode 内置的时间控制

1. 在 Transaction Manager 中
2. 点击右上角的时钟图标
3. 可以手动推进时间

## 新增的调试功能

我已经为你添加了以下调试工具：

### 1. 调试日志

在 `hasExpired` 计算时会打印详细日志：
```
[IAP hasExpired] isPremium: false, expirationDate: 2025-11-10 12:00:00, now: 2025-11-10 13:00:00, previousTier: plus, result: true
```

### 2. 手动刷新按钮

在个人中心 → 点击右上角设置按钮 → "刷新订阅状态 (调试)"

这个按钮会强制刷新订阅状态，并打印详细的调试信息。

## 检查清单

使用以下清单来诊断问题：

```
□ Xcode Scheme 已配置 StoreKit.storekit
□ 已成功购买订阅（能看到会员徽章）
□ 使用 Transaction Manager 的 "Expire Subscription" 让订阅过期
  （不是 Cancel，而是 Expire！）
□ 点击了 "刷新订阅状态 (调试)" 按钮
□ 查看 Xcode 控制台的日志输出
```

## 预期的日志输出

### 订阅有效时
```
[IAP] Current status - isPremium: true, tier: plus, previousTier: plus
[IAP] Subscription expiration date: 2025-12-10 12:00:00, hasExpired: false
[IAP hasExpired] isPremium: true, ... result: false
```

### 订阅过期后
```
[IAP] No current entitlement, checking transaction history...
[IAP] Found expired transaction: com.hulubeici.plus.monthly, expiry: 2025-11-10 12:00:00
[IAP] Subscription expired or cancelled. Previous tier: plus
[IAP] Current status - isPremium: false, tier: none, previousTier: plus
[IAP] Subscription expiration date: 2025-11-10 12:00:00, hasExpired: true
[IAP hasExpired] isPremium: false, expirationDate: 2025-11-10 12:00:00, now: 2025-11-11 08:00:00, previousTier: plus, result: true
```

## 如果还是不行

1. **完全重置测试环境**：
   ```
   - 模拟器中删除 App
   - Xcode: Editor → Clear Trusted Transaction History
   - 清理构建：Product → Clean Build Folder (⇧⌘K)
   - 重新运行 App
   ```

2. **检查 StoreKit Testing 设置**：
   ```
   模拟器 → Settings → Developer → StoreKit Testing
   确保已启用
   ```

3. **查看完整的日志**：
   ```
   在 Xcode 控制台搜索 "[IAP"
   把所有相关日志复制给我看
   ```

## 常见误解

❌ **错误**：点击 "取消订阅" 后就应该显示 "已过期"
✅ **正确**：取消订阅只是不再续订，要等到过期日期到了才会显示 "已过期"

❌ **错误**：Scheme 配置了 StoreKit 就应该自动测试过期
✅ **正确**：需要手动触发过期（Expire Subscription）或等待时间加速

❌ **错误**：重启 App 就能看到过期状态
✅ **正确**：必须先让订阅真正过期（日期过了），然后刷新或重启才能看到
