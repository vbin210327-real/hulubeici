# 葫芦背词 - App Store 上架准备完成总结

**日期：2025年**

---

## ✅ 已完成的工作

### 1. 代码配置修改

#### iOS Deployment Target
- **修改内容**：从 iOS 18.6/18.5 降低到 iOS 17.0
- **影响范围**：扩大用户覆盖范围，支持更多设备
- **修改文件**：`project.pbxproj`
- **状态**：✅ 完成

#### APS Environment
- **修改内容**：从 `development` 改为 `production`
- **重要性**：⚠️ 必须修改，否则 CloudKit 和推送通知在生产环境无法工作
- **修改文件**：`葫芦背词.entitlements`
- **状态**：✅ 完成

#### StoreKit 测试配置
- **修改内容**：从 Release 构建中移除 `StoreKit.storekit`
- **重要性**：确保生产环境使用真实 App Store 支付
- **修改文件**：`project.pbxproj`
- **状态**：✅ 完成

### 2. 文档生成

#### 隐私政策（PrivacyPolicy.md）
- **内容覆盖**：
  - 数据收集和使用说明
  - iCloud 同步机制
  - 订阅信息管理
  - GDPR、CCPA、PIPL 合规
  - 儿童隐私保护
  - 用户权利说明
- **语言**：中文
- **格式**：Markdown（需托管到网站）
- **状态**：✅ 完成

#### 服务条款（TermsOfService.md）
- **内容覆盖**：
  - 服务描述和功能说明
  - 订阅机制和价格
  - 自动续订和取消说明
  - 退款政策
  - 用户行为规范
  - 知识产权声明
  - 免责声明和责任限制
- **语言**：中文
- **格式**：Markdown（需托管到网站）
- **状态**：✅ 完成

#### App Store Connect 订阅配置指南
- **内容**：
  - 详细的订阅产品创建步骤
  - Plus Monthly (¥9/月) 配置
  - Pro Yearly (¥70/年) 配置
  - 沙盒测试说明
  - 常见问题解答
- **目标受众**：您（开发者）
- **状态**：✅ 完成

#### Apple Developer Portal 配置指南
- **内容**：
  - App ID 创建和配置
  - iCloud Container 创建
  - Capabilities 启用
  - Provisioning Profile 配置
  - 证书管理
  - 故障排查
- **目标受众**：您（开发者）
- **状态**：✅ 完成

#### 上架前检查清单
- **内容**：
  - 完整的检查项（200+ 项）
  - 代码配置检查
  - Apple Portal 配置检查
  - App Store Connect 配置检查
  - 功能测试清单
  - Archive 和上传步骤
  - 审核提交流程
- **目标受众**：您（开发者）
- **状态**：✅ 完成

---

## 📋 您需要完成的工作

### 第一步：托管隐私政策和服务条款

**任务**：将生成的文档转换为网页并托管

**选项 1：使用 GitHub Pages（免费，推荐）**

1. 创建一个 GitHub 仓库（可以是私有的）
2. 将 `PrivacyPolicy.md` 和 `TermsOfService.md` 上传
3. 启用 GitHub Pages
4. 获得 URL，例如：
   - `https://your-username.github.io/hulubeici/privacy-policy.html`
   - `https://your-username.github.io/hulubeici/terms-of-service.html`

**选项 2：使用自己的网站**

如果您有网站，直接上传 HTML 版本

**选项 3：使用免费托管服务**

- Vercel：https://vercel.com
- Netlify：https://netlify.com
- Cloudflare Pages：https://pages.cloudflare.com

**重要**：
- URL 必须是 HTTPS
- 页面必须可公开访问（无需登录）
- 建议添加导航，让用户可以从隐私政策跳转到服务条款

---

### 第二步：在 Apple Developer Portal 配置

按照《Apple Developer Portal 配置指南.md》完成：

1. **创建/确认 App ID**
   - Bundle ID：`com.hulubeici`
   - 启用 iCloud、Push Notifications、In-App Purchase

2. **创建 iCloud Container**
   - Container ID：`iCloud.com.hulubeici`
   - 关联到 App ID

3. **创建 Provisioning Profiles**
   - Development Profile
   - Distribution Profile

4. **验证 Xcode 配置**
   - 确认 Team 选择正确
   - 确认 iCloud Container 已勾选
   - 测试真机运行

**预计时间**：30-60 分钟

---

### 第三步：在 App Store Connect 配置

按照《App Store Connect 订阅配置指南.md》完成：

1. **创建 App 记录**（如未创建）
   - App 名称：葫芦背词
   - Bundle ID：com.hulubeici

2. **填写隐私政策和服务条款 URL**
   - 使用第一步托管的 URL

3. **创建订阅组**
   - 组名：premium

4. **创建两个订阅产品**
   - Plus Monthly：`com.hulubeici.plus.monthly` (¥9/月)
   - Pro Yearly：`com.hulubeici.pro.yearly` (¥70/年)

5. **填写本地化信息**
   - 产品描述
   - 显示名称

6. **配置沙盒测试账号**（可选但推荐）

**预计时间**：1-2 小时

---

### 第四步：准备 App 截图和描述

1. **截图要求**：
   - iPhone 6.5 英寸（iPhone 15 Pro Max）：至少 3 张
   - 尺寸：1242 x 2688 像素（或 1290 x 2796）
   - 格式：PNG 或 JPG

2. **截图内容建议**：
   - 主页/单词书列表
   - 学习界面
   - 进度统计
   - 会员页面
   - 个人中心

3. **App 描述**：
   - 2000-4000 字
   - 突出核心功能和价值
   - 提到内置词库和订阅权益

4. **关键词**：
   - 示例：`英语词汇,背单词,四六级,考研英语,托福,单词本,学习,教育`

**预计时间**：2-4 小时（包括截图制作）

---

### 第五步：测试和验证

使用《上架前检查清单.md》进行全面测试：

1. **功能测试**
   - 所有基础功能正常
   - iCloud 同步正常
   - 订阅购买流程正常

2. **真机测试**
   - 至少在一台 iPhone 上测试
   - iOS 17.0 或以上系统

3. **沙盒订阅测试**
   - 使用沙盒账号测试购买
   - 测试订阅恢复
   - 测试订阅过期

**预计时间**：3-5 小时

---

### 第六步：Archive 和上传

1. **清理项目**
   - Product → Clean Build Folder

2. **Archive**
   - 选择"Any iOS Device (arm64)"
   - Product → Archive

3. **验证**
   - Window → Organizer
   - 选择 Archive → Validate App

4. **上传**
   - Distribute App → App Store Connect → Upload
   - 等待处理完成（10-60 分钟）

**预计时间**：30-60 分钟（包括上传和处理）

---

### 第七步：提交审核

1. **在 App Store Connect 中选择构建版本**
2. **填写完整的版本信息**
3. **添加截图和描述**
4. **填写审核备注**
5. **点击"提交以供审核"**

**预计时间**：30 分钟

---

## 📊 时间线规划

### 紧凑时间线（3-4 天）

- **Day 1**：
  - 上午：托管隐私政策和服务条款
  - 下午：配置 Apple Developer Portal

- **Day 2**：
  - 上午：配置 App Store Connect 订阅
  - 下午：准备截图和描述

- **Day 3**：
  - 全天：功能测试和验证

- **Day 4**：
  - 上午：Archive 和上传
  - 下午：提交审核

### 舒适时间线（1-2 周）

- **Week 1**：
  - Day 1-2：Portal 和 Connect 配置
  - Day 3-4：截图准备和文案撰写
  - Day 5-7：功能测试和优化

- **Week 2**：
  - Day 1-2：最终测试
  - Day 3：上传和提交

---

## 🎯 关键保证

### iCloud 数据同步 ✅

**状态**：已完整实现

**技术方案**：
- 使用 CloudKit Private Database
- 自动防抖上传（1 秒延迟）
- 启动时自动拉取最新数据
- 本地 + 云端双重持久化

**同步的数据**：
- 用户个人资料（用户名、头像）
- 所有单词本（自定义+内置）
- 学习进度和统计
- 单词可见性设置

**多设备支持**：
- 用户在设备 A 订阅会员
- 删除 App 并在设备 B 重新安装
- 登录相同 Apple ID 后：
  - ✅ 会员状态自动恢复（通过 StoreKit Transaction API）
  - ✅ 所有学习数据自动同步（通过 iCloud）

---

### 真实支付 ✅

**状态**：已正确配置

**工作原理**：
1. **Debug 模式**：
   - 使用 `StoreKit.storekit` 测试配置
   - 沙盒环境，不产生真实扣费
   - `LocalStoreKitBootstrap` 仅在 DEBUG 和模拟器下激活

2. **Release 模式**：
   - ✅ `StoreKit.storekit` 已从构建中移除
   - ✅ `LocalStoreKitBootstrap` 不会执行（条件编译）
   - ✅ 自动使用 App Store 生产环境
   - ✅ 产生真实扣费

**订阅验证**：
- 使用 StoreKit 2 API
- 通过 `Transaction.currentEntitlements` 验证
- 通过 `Transaction.all` 检查历史记录
- Apple 的交易签名验证
- 不依赖本地存储判断权益（安全）

**订阅恢复**：
- 用户删除 App 后重新安装
- 通过 `PurchaseStore.restore()` 或自动检测
- Apple 自动恢复订阅状态
- 无需用户重新购买

---

## ⚠️ 重要提醒

### 必须完成的任务

以下任务是**阻塞性**的，必须完成才能上架：

1. ✅ **APS Environment 改为 production** - 已完成
2. ⚠️ **创建 iCloud Container** - 您需要完成
3. ⚠️ **在 App Store Connect 创建订阅产品** - 您需要完成
4. ⚠️ **托管隐私政策和服务条款** - 您需要完成

### 隐私政策和服务条款的注意事项

生成的 `PrivacyPolicy.md` 和 `TermsOfService.md` 包含以下需要您填写的占位符：

**需要替换的内容**：
1. **开发者姓名/公司名**：
   - 搜索"[请填写]"并替换

2. **联系邮箱**：
   - 搜索"[请填写您的联系邮箱]"并替换
   - 建议使用专门的支持邮箱，如 support@your-domain.com

3. **仲裁地点**（服务条款中）：
   - 搜索"[请填写仲裁地点]"
   - 建议填写：北京、上海或您所在城市

4. **生效日期**：
   - 将"2025年"改为具体日期，如"2025年1月15日"

---

## 📞 如有问题

### Apple 支持

- **Developer 技术支持**：https://developer.apple.com/support/
- **App Store Connect 支持**：https://developer.apple.com/contact/
- **电话支持**：4006 701 855（中国）

### 常见问题

请参考各个指南文档中的"常见问题"部分

---

## 🎉 恭喜！

您已经完成了所有代码级别的准备工作。现在只需要：

1. 按照指南完成 Portal 和 Connect 配置
2. 准备截图和描述
3. 测试和提交

**预祝审核顺利通过！**

App Store 见！🚀

---

**文档位置**：
- 隐私政策：`/Users/linfanbin/Desktop/葫芦背词/PrivacyPolicy.md`
- 服务条款：`/Users/linfanbin/Desktop/葫芦背词/TermsOfService.md`
- App Store Connect 指南：`/Users/linfanbin/Desktop/葫芦背词/App Store Connect 订阅配置指南.md`
- Developer Portal 指南：`/Users/linfanbin/Desktop/葫芦背词/Apple Developer Portal 配置指南.md`
- 检查清单：`/Users/linfanbin/Desktop/葫芦背词/上架前检查清单.md`
- 本总结：`/Users/linfanbin/Desktop/葫芦背词/上架准备完成总结.md`
