# StoreKit完整配置和测试指南

## 🎯 目标
完整配置StoreKit并在Xcode模拟器中测试付费墙UI和订阅功能

---

## 第一步：将StoreKit.storekit添加到Xcode项目

### 操作步骤

您现在已经在Xcode中打开了`StoreKit.storekit`文件 ✅

接下来需要确保它被添加到项目中：

1. **查看左侧项目导航器**（按 ⌘+1 打开）
   - 您应该能看到文件夹结构
   - 检查是否有 `StoreKit.storekit` 文件（黄色图标）

2. **如果看不到该文件**：
   
   **方法A：拖拽添加**
   - 在Finder中打开项目文件夹：
     - 右键点击桌面上的"葫芦背词"文件夹
     - 选择"在Finder中显示"
   - 找到 `葫芦背词/StoreKit.storekit` 文件
   - **拖拽**这个文件到Xcode左侧导航器的项目根目录
   - 在弹出的对话框中：
     - ✅ 勾选 "Copy items if needed"
     - ✅ 勾选 "Add to targets: 葫芦背词"
     - 点击 "Finish"

   **方法B：通过菜单添加**
   - 在Xcode中，选择菜单：**File → Add Files to "葫芦背词"...**
   - 导航到项目文件夹，选择 `StoreKit.storekit`
   - 确保勾选 "Add to targets"
   - 点击 "Add"

3. **验证添加成功**：
   - 左侧项目导航器中应该显示 `StoreKit.storekit` 文件
   - 文件图标应该是黄色的StoreKit图标

---

## 第二步：配置Scheme使用StoreKit

1. **打开Scheme编辑器**：
   - 点击顶部工具栏的 **Scheme选择器**（显示"葫芦背词"的地方）
   - 选择 **"Edit Scheme..."**
   - 或使用快捷键：**⌘ + <**

2. **选择Run配置**：
   - 在左侧选择 **"Run"**
   - 点击 **"Options"** 标签页

3. **设置StoreKit Configuration**：
   - 找到 **"StoreKit Configuration"** 下拉菜单
   - 现在应该能看到 **"StoreKit.storekit"** 选项
   - 选择它
   - 点击 **"Close"**

4. **如果仍然看不到StoreKit.storekit选项**：
   - 关闭Xcode
   - 重新打开项目
   - 再次尝试上述步骤

---

## 第三步：验证StoreKit配置内容

您的`StoreKit.storekit`文件应该包含：

### ✅ 已配置的内容

**订阅组**：
- Group ID: `6A14F3B8`
- Group Name: `premium`

**月度订阅**：
- Product ID: `com.hulubeici.plus.monthly`
- 价格: ¥9
- 周期: 1个月
- 免费试用: 无

**年度订阅**：
- Product ID: `com.hulubeici.pro.yearly`
- 价格: ¥70
- 周期: 1年
- ✨ **免费试用: 7天** ← 已配置

---

## 第四步：在模拟器中运行App

1. **选择模拟器**：
   - 在Xcode顶部，点击设备选择器
   - 选择任意iPhone模拟器（推荐 iPhone 15 Pro）

2. **构建并运行**：
   - 按 **⌘ + R**
   - 或点击顶部的 **▶️ 播放按钮**

3. **等待App启动**：
   - 首次启动可能需要10-30秒
   - 模拟器会自动打开并加载App

---

## 第五步：导航到付费墙

根据您的App流程，可能需要：

**选项A：如果是首次启动**
- App可能会自动显示引导页
- 完成引导后可能会弹出付费墙

**选项B：通过设置进入**
- 打开App主界面
- 查找"设置"、"升级"、"会员"等入口
- 点击进入付费墙

**选项C：通过受限功能触发**
- 尝试使用需要会员权限的功能
- 应该会自动弹出付费墙

---

## 第六步：检查UI效果

当付费墙显示后，您应该看到：

### 📱 月度订阅卡片
```
┌─────────────────────────────────────┐
│  Plus 月度                    ¥9   │
│  ¥9/月 · 可随时取消订阅             │
└─────────────────────────────────────┘
```

### 📱 年度订阅卡片（重点检查）
```
┌─────────────────────────────────────┐
│  🎁 前7天免费试用  ← 应该显示！     │
│                                     │
│  Pro 年度                  ¥70     │
│  含 7 天 免费试用                   │
│  仅¥5.8/月 · 可随时取消订阅         │
└─────────────────────────────────────┘
```

### ✅ UI检查清单

- [ ] 年度订阅卡片顶部显示渐变标签
- [ ] 标签颜色：绿色到蓝色渐变
- [ ] 标签文字："前7天免费试用"
- [ ] 包含礼物图标 🎁
- [ ] 标签位置：卡片左上角
- [ ] 月度订阅**没有**显示此标签
- [ ] 产品价格正确显示（¥9 和 ¥70）
- [ ] 整体布局美观清晰

---

## 第七步：测试订阅购买流程

### 测试年度订阅（带免费试用）

1. **点击年度订阅卡片**选中它

2. **点击"继续"按钮**

3. **Apple购买弹窗应该显示**：
   ```
   Pro 年度会员
   前7天免费，之后每年¥70.00
   
   试用期结束后自动续期
   可随时取消
   
   [订阅] [取消]
   ```

4. **验证关键信息**：
   - ✅ 显示"前7天免费"或"7 Days Free"
   - ✅ 显示"之后每年¥70"
   - ✅ 说明可以取消

5. **点击"订阅"**：
   - 在沙盒环境中，无需输入支付信息
   - 直接确认即可完成购买

---

## 第八步：验证订阅状态

购买成功后，验证：

### App内状态

1. **付费墙应该自动关闭**
   - 如果实现了自动关闭逻辑

2. **检查会员状态**：
   - 进入App设置或个人资料页面
   - 应该显示为Pro会员
   - 显示订阅到期时间（7天后）

3. **测试会员功能**：
   - 尝试使用高级功能
   - 应该可以正常访问

### 在模拟器设置中查看

1. **打开模拟器的设置App**

2. **导航到订阅管理**：
   - 设置 → Apple ID（顶部）→ 订阅
   - 或 设置 → App Store → [你的账号] → 订阅

3. **查看订阅详情**：
   - 应该显示"葫芦背词 - Pro 年度"
   - 状态：试用中
   - 到期日期：7天后（沙盒环境可能显示为几分钟后）

---

## 第九步：测试取消订阅

### 在模拟器中取消

1. **在模拟器设置中**：
   - 设置 → 订阅 → 葫芦背词
   - 点击 **"取消订阅"**
   - 确认取消

2. **验证App行为**：
   - 返回App
   - 会员权益应该继续有效（直到试用期结束）
   - 检查App是否正确显示"订阅将在X天后到期"

---

## 🎉 测试完成检查清单

### UI测试
- [ ] 免费试用标签正确显示
- [ ] 标签样式美观（渐变、图标、文字）
- [ ] 仅年度订阅显示标签
- [ ] 产品价格正确加载

### 功能测试
- [ ] 可以成功点击订阅
- [ ] Apple购买弹窗显示试用信息
- [ ] 购买后获得会员权益
- [ ] 订阅状态正确更新
- [ ] 可以取消订阅
- [ ] 取消后试用期仍然有效

---

## 🔧 常见问题解决

### 问题1：产品无法加载

**现象**：付费墙显示"正在加载商店价格..."

**解决方法**：
1. 检查Scheme → Options → StoreKit Configuration是否已选择
2. Clean Build（⇧ + ⌘ + K）
3. 重新运行

### 问题2：免费试用标签不显示

**现象**：年度订阅卡片没有显示标签

**原因**：StoreKit配置中没有设置试用

**解决方法**：
1. 在Xcode中打开`StoreKit.storekit`
2. 选择年度订阅产品
3. 在右侧属性面板添加Introductory Offer
4. Type: Free Trial, Duration: 7 Days

### 问题3：购买后没有获得会员权益

**原因**：订阅状态未正确刷新

**解决方法**：
1. 检查`PurchaseStore.swift`中的刷新逻辑
2. 重启App
3. 检查控制台日志

---

## 📸 截图记录

建议在测试过程中截图：

1. 付费墙UI（显示免费试用标签）
2. Apple购买弹窗（显示试用条款）
3. 订阅成功后的会员页面
4. 模拟器设置中的订阅详情

这些截图可用于：
- 文档记录
- 用户支持
- 营销材料

---

现在，让我们开始第一步！请按照上述步骤操作，遇到任何问题随时告诉我。
