# 测试订阅过期功能步骤

## 1. 在 Xcode 中运行 App
确保使用模拟器运行，并且 StoreKit 配置文件已启用。

## 2. 购买订阅
- 打开 App
- 进入个人中心或付费页面
- 购买 Plus Monthly 或 Pro Yearly 订阅
- 确认购买成功后，个人中心应该显示会员徽章

## 3. 打开 StoreKit Transaction Manager
在 Xcode 菜单栏：
- **Debug** → **StoreKit** → **Manage Transactions...**
- 或者快捷键：**⇧⌘T** (Shift + Command + T)

## 4. 让订阅过期
在 Transaction Manager 窗口中：
1. 找到你的订阅交易（应该显示 "com.hulubeici.plus.monthly" 或 "com.hulubeici.pro.yearly"）
2. 选中该交易
3. 在窗口底部或右键菜单中，找到 **"Expire Subscription"** 选项
4. 点击 "Expire Subscription"

⚠️ 注意：如果看不到 "Expire Subscription" 选项，可能是：
   - 订阅已经过期
   - 没有选中正确的订阅项
   - StoreKit Testing 没有正确配置

## 5. 验证过期状态
让订阅过期后：
1. 回到 App（可能需要重启 App）
2. 进入个人中心（"我的"页面）
3. 你应该看到：
   - 灰色徽章显示："Plus会员已过期" 或 "Pro会员已过期"
   - 红色文字显示："已于 [日期] 过期"

## 6. 查看控制台日志
在 Xcode 控制台，你应该看到类似的日志：
```
[IAP] Subscription expired or cancelled. Previous tier: plus
[IAP] Subscription expiration date: 2025-11-10 12:00:00 +0000, isPremium: false, hasExpired: true
```

## 故障排查

### 如果看不到 "Expire Subscription" 选项：
1. 确保你选中的是 **Auto-Renewable Subscription** 类型的交易
2. 尝试先 "Refund Purchase"，然后重新购买并过期

### 如果过期后没有显示"已过期"：
1. 检查控制台日志中的 `hasExpired` 值
2. 尝试完全关闭并重新运行 App
3. 检查是否有错误日志

### 清除测试数据重新开始：
如果需要重置所有订阅数据：
1. 在模拟器中删除 App
2. 在 Xcode: Editor → Clear Trusted Transaction History
3. 重新运行 App
